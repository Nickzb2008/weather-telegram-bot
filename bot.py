import os
import logging
import sys
import json
from datetime import datetime
import asyncio
from typing import Dict, List, Optional, Tuple
import math

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ª–æ–≥—É–≤–∞–Ω–Ω—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO,
    stream=sys.stdout
)
logger = logging.getLogger(__name__)

print("=" * 60)
print("üá∫üá¶ UKRAINE WEATHER BOT WITH COMPLETE SETTLEMENTS DATABASE")
print("=" * 60)

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–º—ñ–Ω–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
TELEGRAM_TOKEN = os.getenv('TELEGRAM_TOKEN')

if not TELEGRAM_TOKEN:
    print("‚ùå ERROR: TELEGRAM_TOKEN not found!")
    print("Add TELEGRAM_TOKEN environment variable on Render")
    sys.exit(1)

print(f"‚úÖ TELEGRAM_TOKEN: OK")
print("‚úÖ OPEN-METEO: FREE TIER (no API key needed)")
print("=" * 60)

# –Ü–º–ø–æ—Ä—Ç –±—ñ–±–ª—ñ–æ—Ç–µ–∫
try:
    import requests
    from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
    from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, CallbackQueryHandler
    print("‚úÖ Libraries imported successfully")
except ImportError as e:
    print(f"‚ùå Import error: {e}")
    sys.exit(1)

# ============================================================================
# –ü–û–í–ù–ê –ë–ê–ó–ê –ù–ê–°–ï–õ–ï–ù–ò–• –ü–£–ù–ö–¢–Ü–í –£–ö–†–ê–á–ù–ò –ó –û–ë–õ–ê–°–¢–Ø–ú–ò
# ============================================================================

# –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –Ω–∞–∑–≤–∞_–º—ñ—Å—Ç–∞: [—Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å—ñ–≤ –¥–ª—è –∫–æ–∂–Ω–æ—ó –æ–±–ª–∞—Å—Ç—ñ]
UKRAINE_SETTLEMENTS = {
    # –ê–≤—Ç–æ–Ω–æ–º–Ω–∞ –†–µ—Å–ø—É–±–ª—ñ–∫–∞ –ö—Ä–∏–º
    "–°—ñ–º—Ñ–µ—Ä–æ–ø–æ–ª—å": [
        {"lat": 44.9521, "lon": 34.1024, "region": "–ê–† –ö—Ä–∏–º", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 332000}
    ],
    "–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å": [
        {"lat": 44.6167, "lon": 33.5254, "region": "–ê–† –ö—Ä–∏–º", "type": "–º—ñ—Å—Ç–æ", "population": 343000}
    ],
    "–Ø–ª—Ç–∞": [
        {"lat": 44.5022, "lon": 34.1664, "region": "–ê–† –ö—Ä–∏–º", "type": "–º—ñ—Å—Ç–æ", "population": 79000}
    ],
    
    # –í—ñ–Ω–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–í—ñ–Ω–Ω–∏—Ü—è": [
        {"lat": 49.2328, "lon": 28.4816, "region": "–í—ñ–Ω–Ω–∏—Ü—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 369000}
    ],
    "–ë–∞—Ä": [
        {"lat": 49.0769, "lon": 27.6825, "region": "–í—ñ–Ω–Ω–∏—Ü—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 16000}
    ],
    "–ë–µ—Ä—à–∞–¥—å": [
        {"lat": 48.3758, "lon": 29.5333, "region": "–í—ñ–Ω–Ω–∏—Ü—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 13000}
    ],
    
    # –í–æ–ª–∏–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–õ—É—Ü—å–∫": [
        {"lat": 50.7472, "lon": 25.3254, "region": "–í–æ–ª–∏–Ω—Å—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 217000}
    ],
    "–í–æ–ª–æ–¥–∏–º–∏—Ä": [
        {"lat": 50.8478, "lon": 24.3222, "region": "–í–æ–ª–∏–Ω—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 38000}
    ],
    
    # –î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–î–Ω—ñ–ø—Ä–æ": [
        {"lat": 48.4647, "lon": 35.0462, "region": "–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 966000}
    ],
    "–ö—Ä–∏–≤–∏–π –†—ñ–≥": [
        {"lat": 47.9105, "lon": 33.3918, "region": "–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 612000}
    ],
    
    # –î–æ–Ω–µ—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–î–æ–Ω–µ—Ü—å–∫": [
        {"lat": 48.0159, "lon": 37.8028, "region": "–î–æ–Ω–µ—Ü—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 901000}
    ],
    "–ú–∞—Ä—ñ—É–ø–æ–ª—å": [
        {"lat": 47.0971, "lon": 37.5434, "region": "–î–æ–Ω–µ—Ü—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 431000}
    ],
    
    # –ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–ñ–∏—Ç–æ–º–∏—Ä": [
        {"lat": 50.2547, "lon": 28.6587, "region": "–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 261000}
    ],
    "–ë–µ—Ä–¥–∏—á—ñ–≤": [
        {"lat": 49.8917, "lon": 28.6000, "region": "–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 75000}
    ],
    "–ö–æ—Ä–æ—Å—Ç–µ–Ω—å": [
        {"lat": 50.9500, "lon": 28.6500, "region": "–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 62000}
    ],
    "–ù–æ–≤–æ–≥—Ä–∞–¥-–í–æ–ª–∏–Ω—Å—å–∫–∏–π": [
        {"lat": 50.5833, "lon": 27.6333, "region": "–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 56000}
    ],
    
    # –ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–£–∂–≥–æ—Ä–æ–¥": [
        {"lat": 48.6208, "lon": 22.2879, "region": "–ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 115000}
    ],
    "–ú—É–∫–∞—á–µ–≤–æ": [
        {"lat": 48.4412, "lon": 22.7176, "region": "–ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 85000}
    ],
    "–•—É—Å—Ç": [
        {"lat": 48.1761, "lon": 23.2994, "region": "–ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 29000}
    ],
    "–ë–µ—Ä–µ–≥–æ–≤–µ": [
        {"lat": 48.2044, "lon": 22.6386, "region": "–ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 23000}
    ],
    
    # –ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–ó–∞–ø–æ—Ä—ñ–∂–∂—è": [
        {"lat": 47.8229, "lon": 35.1903, "region": "–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 722000}
    ],
    "–ú–µ–ª—ñ—Ç–æ–ø–æ–ª—å": [
        {"lat": 46.8489, "lon": 35.3653, "region": "–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 150000}
    ],
    "–ë–µ—Ä–¥—è–Ω—Å—å–∫": [
        {"lat": 46.7590, "lon": 36.7869, "region": "–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 107000}
    ],
    "–ï–Ω–µ—Ä–≥–æ–¥–∞—Ä": [
        {"lat": 47.4989, "lon": 34.6558, "region": "–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 53000}
    ],
    
    # –Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫": [
        {"lat": 48.9226, "lon": 24.7111, "region": "–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 238000}
    ],
    "–ö–∞–ª—É—à": [
        {"lat": 49.0428, "lon": 24.3608, "region": "–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 65000}
    ],
    "–ö–æ–ª–æ–º–∏—è": [
        {"lat": 48.5306, "lon": 25.0403, "region": "–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 61000}
    ],
    "–Ø—Ä–µ–º—á–µ": [
        {"lat": 48.4547, "lon": 24.5550, "region": "–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 8000}
    ],
    
    # –ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–ö–∏—ó–≤": [
        {"lat": 50.4501, "lon": 30.5234, "region": "–ö–∏—ó–≤—Å—å–∫–∞", "type": "—Å—Ç–æ–ª–∏—Ü—è", "population": 2967000}
    ],
    "–ë—ñ–ª–∞ –¶–µ—Ä–∫–≤–∞": [
        {"lat": 49.7956, "lon": 30.1167, "region": "–ö–∏—ó–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 208000}
    ],
    "–ë—Ä–æ–≤–∞—Ä–∏": [
        {"lat": 50.5114, "lon": 30.7903, "region": "–ö–∏—ó–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 109000}
    ],
    "–ë–æ—Ä–∏—Å–ø—ñ–ª—å": [
        {"lat": 50.3528, "lon": 30.9550, "region": "–ö–∏—ó–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 63000}
    ],
    "–§–∞—Å—Ç—ñ–≤": [
        {"lat": 50.0747, "lon": 29.9183, "region": "–ö–∏—ó–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 45000}
    ],
    "–Ü—Ä–ø—ñ–Ω—å": [
        {"lat": 50.5167, "lon": 30.2500, "region": "–ö–∏—ó–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 60000}
    ],
    "–ë—É—á–∞": [
        {"lat": 50.5500, "lon": 30.2167, "region": "–ö–∏—ó–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 36000}
    ],
    
    # –ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å (–ö—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∞)
    "–ö—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π": [
        {"lat": 48.5132, "lon": 32.2597, "region": "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 222000}
    ],
    "–û–ª–µ–∫—Å–∞–Ω–¥—Ä—ñ—è": [
        {"lat": 48.6697, "lon": 33.1206, "region": "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 82000}
    ],
    "–°–≤—ñ—Ç–ª–æ–≤–æ–¥—Å—å–∫": [
        {"lat": 49.0833, "lon": 33.2500, "region": "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 44000}
    ],
    "–ó–Ω–∞–º'—è–Ω–∫–∞": [
        {"lat": 48.7136, "lon": 32.6733, "region": "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 23000}
    ],
    
    # –õ—å–≤—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–õ—å–≤—ñ–≤": [
        {"lat": 49.8397, "lon": 24.0297, "region": "–õ—å–≤—ñ–≤—Å—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 717000}
    ],
    "–î—Ä–æ–≥–æ–±–∏—á": [
        {"lat": 49.3500, "lon": 23.5000, "region": "–õ—å–≤—ñ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 74000}
    ],
    "–ß–µ—Ä–≤–æ–Ω–æ–≥—Ä–∞–¥": [
        {"lat": 50.3833, "lon": 24.2333, "region": "–õ—å–≤—ñ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 65000}
    ],
    "–°—Ç—Ä–∏–π": [
        {"lat": 49.2553, "lon": 23.8506, "region": "–õ—å–≤—ñ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 59000}
    ],
    "–°–∞–º–±—ñ—Ä": [
        {"lat": 49.5167, "lon": 23.2000, "region": "–õ—å–≤—ñ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 34000}
    ],
    "–ë–æ—Ä–∏—Å–ª–∞–≤": [
        {"lat": 49.2861, "lon": 23.4231, "region": "–õ—å–≤—ñ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 33000}
    ],
    "–ù–æ–≤–∏–π –†–æ–∑–¥—ñ–ª": [
        {"lat": 49.4700, "lon": 24.1300, "region": "–õ—å–≤—ñ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 28000}
    ],
    
    # –ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–ú–∏–∫–æ–ª–∞—ó–≤": [
        {"lat": 46.9750, "lon": 31.9946, "region": "–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 480000}
    ],
    "–ü–µ—Ä–≤–æ–º–∞–π—Å—å–∫": [
        {"lat": 48.0500, "lon": 30.8500, "region": "–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 66000}
    ],
    "–Æ–∂–Ω–æ—É–∫—Ä–∞—ó–Ω—Å—å–∫": [
        {"lat": 47.8208, "lon": 31.1775, "region": "–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 39000}
    ],
    "–í–æ–∑–Ω–µ—Å–µ–Ω—Å—å–∫": [
        {"lat": 47.5667, "lon": 31.3333, "region": "–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 34000}
    ],
    "–û—á–∞–∫—ñ–≤": [
        {"lat": 46.6167, "lon": 31.5500, "region": "–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 14000}
    ],
    
    # –û–¥–µ—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–û–¥–µ—Å–∞": [
        {"lat": 46.4825, "lon": 30.7233, "region": "–û–¥–µ—Å—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 1017000}
    ],
    "–Ü–∑–º–∞—ó–ª": [
        {"lat": 45.3500, "lon": 28.8333, "region": "–û–¥–µ—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 71000}
    ],
    "–ß–æ—Ä–Ω–æ–º–æ—Ä—Å—å–∫": [
        {"lat": 46.3011, "lon": 30.6569, "region": "–û–¥–µ—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 59000}
    ],
    "–ë—ñ–ª–≥–æ—Ä–æ–¥-–î–Ω—ñ—Å—Ç—Ä–æ–≤—Å—å–∫–∏–π": [
        {"lat": 46.1833, "lon": 30.3333, "region": "–û–¥–µ—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 48000}
    ],
    "–Æ–∂–Ω–µ": [
        {"lat": 46.6217, "lon": 31.1011, "region": "–û–¥–µ—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 32000}
    ],
    "–ë–∞–ª—Ç–∞": [
        {"lat": 47.9333, "lon": 29.6167, "region": "–û–¥–µ—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 18000}
    ],
    
    # –ü–æ–ª—Ç–∞–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–ü–æ–ª—Ç–∞–≤–∞": [
        {"lat": 49.5883, "lon": 34.5514, "region": "–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 279000}
    ],
    "–ö—Ä–µ–º–µ–Ω—á—É–∫": [
        {"lat": 49.0667, "lon": 33.4167, "region": "–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 217000}
    ],
    "–õ—É–±–Ω–∏": [
        {"lat": 50.0167, "lon": 33.0000, "region": "–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 45000}
    ],
    "–ì–æ—Ä—ñ—à–Ω—ñ –ü–ª–∞–≤–Ω—ñ": [
        {"lat": 49.0094, "lon": 33.6450, "region": "–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 50000}
    ],
    "–ú–∏—Ä–≥–æ—Ä–æ–¥": [
        {"lat": 49.9667, "lon": 33.6000, "region": "–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 39000}
    ],
    "–•–æ—Ä–æ–ª": [
        {"lat": 49.7833, "lon": 33.2500, "region": "–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 13000}
    ],
    
    # –†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–†—ñ–≤–Ω–µ": [
        {"lat": 50.6199, "lon": 26.2516, "region": "–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 246000}
    ],
    "–î—É–±–Ω–æ": [
        {"lat": 50.3939, "lon": 25.7592, "region": "–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 37000}
    ],
    "–ö–æ—Å—Ç–æ–ø—ñ–ª—å": [
        {"lat": 50.8833, "lon": 26.4333, "region": "–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 31000}
    ],
    "–ó–¥–æ–ª–±—É–Ω—ñ–≤": [
        {"lat": 50.5167, "lon": 26.2500, "region": "–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 24000}
    ],
    "–í–∞—Ä–∞—à": [
        {"lat": 51.3333, "lon": 25.8500, "region": "–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 42000}
    ],
    
    # –°—É–º—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–°—É–º–∏": [
        {"lat": 50.9077, "lon": 34.7981, "region": "–°—É–º—Å—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 259000}
    ],
    "–ö–æ–Ω–æ—Ç–æ–ø": [
        {"lat": 51.2369, "lon": 33.2027, "region": "–°—É–º—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 84000}
    ],
    "–®–æ—Å—Ç–∫–∞": [
        {"lat": 51.8667, "lon": 33.4833, "region": "–°—É–º—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 73000}
    ],
    "–û—Ö—Ç–∏—Ä–∫–∞": [
        {"lat": 50.3000, "lon": 34.9000, "region": "–°—É–º—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 47000}
    ],
    "–†–æ–º–Ω–∏": [
        {"lat": 50.7431, "lon": 33.4839, "region": "–°—É–º—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 38000}
    ],
    "–ì–ª—É—Ö—ñ–≤": [
        {"lat": 51.6781, "lon": 33.9167, "region": "–°—É–º—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 33000}
    ],
    
    # –¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å": [
        {"lat": 49.5535, "lon": 25.5948, "region": "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 225000}
    ],
    "–ö—Ä–µ–º–µ–Ω–µ—Ü—å": [
        {"lat": 50.1167, "lon": 25.7333, "region": "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 20000}
    ],
    "–ß–æ—Ä—Ç–∫—ñ–≤": [
        {"lat": 49.0167, "lon": 25.8000, "region": "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 29000}
    ],
    "–ë–µ—Ä–µ–∂–∞–Ω–∏": [
        {"lat": 49.4500, "lon": 24.9333, "region": "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 17000}
    ],
    
    # –•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–•–∞—Ä–∫—ñ–≤": [
        {"lat": 49.9935, "lon": 36.2304, "region": "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 1441000}
    ],
    "–õ–æ–∑–æ–≤–∞": [
        {"lat": 48.8833, "lon": 36.3167, "region": "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 57000}
    ],
    "–Ü–∑—é–º": [
        {"lat": 49.2125, "lon": 37.2617, "region": "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 46000}
    ],
    "–ö—É–ø'—è–Ω—Å—å–∫": [
        {"lat": 49.7064, "lon": 37.6167, "region": "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 27000}
    ],
    "–ü–µ—Ä–≤–æ–º–∞–π—Å—å–∫–∏–π": [
        {"lat": 49.3833, "lon": 36.2167, "region": "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 29000}
    ],
    "–ë–∞–ª–∞–∫–ª—ñ—è": [
        {"lat": 49.4567, "lon": 36.8511, "region": "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 27000}
    ],
    
    # –•–µ—Ä—Å–æ–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–•–µ—Ä—Å–æ–Ω": [
        {"lat": 46.6354, "lon": 32.6169, "region": "–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 283000}
    ],
    "–ù–æ–≤–∞ –ö–∞—Ö–æ–≤–∫–∞": [
        {"lat": 46.7500, "lon": 33.3667, "region": "–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 45000}
    ],
    "–ö–∞—Ö–æ–≤–∫–∞": [
        {"lat": 46.8000, "lon": 33.4667, "region": "–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 35000}
    ],
    "–°–∫–∞–¥–æ–≤—Å—å–∫": [
        {"lat": 46.1167, "lon": 32.9167, "region": "–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 18000}
    ],
    "–ì–µ–Ω—ñ—á–µ—Å—å–∫": [
        {"lat": 46.1833, "lon": 34.8000, "region": "–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 19000}
    ],
    
    # –•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π": [
        {"lat": 49.4220, "lon": 26.9841, "region": "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 274000}
    ],
    "–ö–∞–º'—è–Ω–µ—Ü—å-–ü–æ–¥—ñ–ª—å—Å—å–∫–∏–π": [
        {"lat": 48.6806, "lon": 26.5806, "region": "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 98000}
    ],
    "–®–µ–ø–µ—Ç—ñ–≤–∫–∞": [
        {"lat": 50.1833, "lon": 27.0667, "region": "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 40000}
    ],
    "–°–ª–∞–≤—É—Ç–∞": [
        {"lat": 50.3000, "lon": 26.8667, "region": "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 34000}
    ],
    "–ù–µ—Ç—ñ—à–∏–Ω": [
        {"lat": 50.3333, "lon": 26.6333, "region": "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 34000}
    ],
    "–°—Ç–∞—Ä–æ–∫–æ—Å—Ç—è–Ω—Ç–∏–Ω—ñ–≤": [
        {"lat": 49.7572, "lon": 27.2083, "region": "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 34000}
    ],
    
    # –ß–µ—Ä–∫–∞—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–ß–µ—Ä–∫–∞—Å–∏": [
        {"lat": 49.4444, "lon": 32.0598, "region": "–ß–µ—Ä–∫–∞—Å—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 269000}
    ],
    "–£–º–∞–Ω—å": [
        {"lat": 48.7500, "lon": 30.2167, "region": "–ß–µ—Ä–∫–∞—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 82000}
    ],
    "–°–º—ñ–ª–∞": [
        {"lat": 49.2167, "lon": 31.8667, "region": "–ß–µ—Ä–∫–∞—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 68000}
    ],
    "–ó–æ–ª–æ—Ç–æ–Ω–æ—à–∞": [
        {"lat": 49.6833, "lon": 32.0333, "region": "–ß–µ—Ä–∫–∞—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 28000}
    ],
    "–ö–∞–Ω—ñ–≤": [
        {"lat": 49.7500, "lon": 31.4667, "region": "–ß–µ—Ä–∫–∞—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 25000}
    ],
    "–í–∞—Ç—É—Ç—ñ–Ω–µ": [
        {"lat": 49.0167, "lon": 31.0667, "region": "–ß–µ—Ä–∫–∞—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 17000}
    ],
    
    # –ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–ß–µ—Ä–Ω—ñ–≤—Ü—ñ": [
        {"lat": 48.2921, "lon": 25.9358, "region": "–ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 265000}
    ],
    "–°—Ç–æ—Ä–æ–∂–∏–Ω–µ—Ü—å": [
        {"lat": 48.1667, "lon": 25.7167, "region": "–ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 14000}
    ],
    "–•–æ—Ç–∏–Ω": [
        {"lat": 48.5078, "lon": 26.4922, "region": "–ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 9000}
    ],
    "–ù–æ–≤–æ–¥–Ω—ñ—Å—Ç—Ä–æ–≤—Å—å–∫": [
        {"lat": 48.5833, "lon": 27.4333, "region": "–ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 10000}
    ],
    
    # –ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    "–ß–µ—Ä–Ω—ñ–≥—ñ–≤": [
        {"lat": 51.4982, "lon": 31.2893, "region": "–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞", "type": "–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä", "population": 286000}
    ],
    "–ù—ñ–∂–∏–Ω": [
        {"lat": 51.0450, "lon": 31.8800, "region": "–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 66000}
    ],
    "–ü—Ä–∏–ª—É–∫–∏": [
        {"lat": 50.5933, "lon": 32.3867, "region": "–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 55000}
    ],
    "–ë–∞—Ö–º–∞—á": [
        {"lat": 51.1833, "lon": 32.8333, "region": "–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 18000}
    ],
    "–ù–æ–≤–≥–æ—Ä–æ–¥-–°—ñ–≤–µ—Ä—Å—å–∫–∏–π": [
        {"lat": 52.0069, "lon": 33.2611, "region": "–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 13000}
    ],
    
    # –ú—ñ—Å—Ç–∞ –∑ –æ–¥–Ω–∞–∫–æ–≤–æ—é –Ω–∞–∑–≤–æ—é –≤ —Ä—ñ–∑–Ω–∏—Ö –æ–±–ª–∞—Å—Ç—è—Ö
    "–ù–æ–≤–æ–≥—Ä–∞–¥": [
        {"lat": 48.5333, "lon": 27.4833, "region": "–í—ñ–Ω–Ω–∏—Ü—å–∫–∞", "type": "—Å–µ–ª–∏—â–µ", "population": 5000, "full_name": "–ù–æ–≤–æ–≥—Ä–∞–¥ (–í—ñ–Ω–Ω–∏—Ü—å–∫–∞)"},
        {"lat": 50.5833, "lon": 27.6333, "region": "–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 56000, "full_name": "–ù–æ–≤–æ–≥—Ä–∞–¥-–í–æ–ª–∏–Ω—Å—å–∫–∏–π (–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞)"},
        {"lat": 49.0167, "lon": 33.8833, "region": "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞", "type": "—Å–µ–ª–∏—â–µ", "population": 3000, "full_name": "–ù–æ–≤–æ–≥—Ä–∞–¥ (–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞)"}
    ],
    
    "–ü–µ—Ä–≤–æ–º–∞–π—Å—å–∫": [
        {"lat": 48.0500, "lon": 30.8500, "region": "–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 66000, "full_name": "–ü–µ—Ä–≤–æ–º–∞–π—Å—å–∫ (–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞)"},
        {"lat": 49.3833, "lon": 36.2167, "region": "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 29000, "full_name": "–ü–µ—Ä–≤–æ–º–∞–π—Å—å–∫–∏–π (–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞)"}
    ],
    
    "–ö–æ—Å—Ç—è–Ω—Ç–∏–Ω—ñ–≤–∫–∞": [
        {"lat": 48.5278, "lon": 37.7056, "region": "–î–æ–Ω–µ—Ü—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 70000, "full_name": "–ö–æ—Å—Ç—è–Ω—Ç–∏–Ω—ñ–≤–∫–∞ (–î–æ–Ω–µ—Ü—å–∫–∞)"},
        {"lat": 49.7572, "lon": 27.2083, "region": "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 34000, "full_name": "–°—Ç–∞—Ä–æ–∫–æ—Å—Ç—è–Ω—Ç–∏–Ω—ñ–≤ (–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞)"}
    ],
    
    "–°–ª–æ–≤'—è–Ω—Å—å–∫": [
        {"lat": 48.8531, "lon": 37.6050, "region": "–î–æ–Ω–µ—Ü—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 106000, "full_name": "–°–ª–æ–≤'—è–Ω—Å—å–∫ (–î–æ–Ω–µ—Ü—å–∫–∞)"},
        {"lat": 49.3853, "lon": 23.0042, "region": "–õ—å–≤—ñ–≤—Å—å–∫–∞", "type": "—Å–µ–ª–∏—â–µ", "population": 2000, "full_name": "–°–ª–æ–≤'—è–Ω—Å—å–∫ (–õ—å–≤—ñ–≤—Å—å–∫–∞)"}
    ],
    
    "–û–ª–µ–∫—Å–∞–Ω–¥—Ä—ñ—è": [
        {"lat": 48.6697, "lon": 33.1206, "region": "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 82000, "full_name": "–û–ª–µ–∫—Å–∞–Ω–¥—Ä—ñ—è (–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞)"},
        {"lat": 50.8833, "lon": 26.4333, "region": "–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞", "type": "–º—ñ—Å—Ç–æ", "population": 31000, "full_name": "–ö–æ—Å—Ç–æ–ø—ñ–ª—å (–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞)"}
    ],
    
    # –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å–µ–ª–∏—â–∞ –º—ñ—Å—å–∫–æ–≥–æ —Ç–∏–ø—É
    "–®–∞—Ü—å–∫": [
        {"lat": 51.4833, "lon": 23.9333, "region": "–í–æ–ª–∏–Ω—Å—å–∫–∞", "type": "—Å–µ–ª–∏—â–µ –º—ñ—Å—å–∫–æ–≥–æ —Ç–∏–ø—É", "population": 5300}
    ],
    "–°–∫–∞–ª–∞—Ç": [
        {"lat": 49.4275, "lon": 25.9783, "region": "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞", "type": "—Å–µ–ª–∏—â–µ –º—ñ—Å—å–∫–æ–≥–æ —Ç–∏–ø—É", "population": 4000}
    ],
    "–ë–µ—Ä–µ—Å—Ç–µ—á–∫–æ": [
        {"lat": 50.3500, "lon": 25.1167, "region": "–í–æ–ª–∏–Ω—Å—å–∫–∞", "type": "—Å–µ–ª–∏—â–µ –º—ñ—Å—å–∫–æ–≥–æ —Ç–∏–ø—É", "population": 1700}
    ],
    "–ë–∞—Ç—É—Ä–∏–Ω": [
        {"lat": 51.3333, "lon": 32.8833, "region": "–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞", "type": "—Å–µ–ª–∏—â–µ –º—ñ—Å—å–∫–æ–≥–æ —Ç–∏–ø—É", "population": 2500}
    ],
    "–ì—É—Å—è—Ç–∏–Ω": [
        {"lat": 49.0667, "lon": 26.2167, "region": "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞", "type": "—Å–µ–ª–∏—â–µ –º—ñ—Å—å–∫–æ–≥–æ —Ç–∏–ø—É", "population": 7000}
    ],
}

# –°—Ç–≤–æ—Ä—é—î–º–æ —Å–ø–∏—Å–æ–∫ —É—Å—ñ—Ö —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –Ω–∞–∑–≤
ALL_SETTLEMENT_NAMES = list(UKRAINE_SETTLEMENTS.keys())

def find_settlements_by_prefix(prefix: str) -> List[dict]:
    """
    –ó–Ω–∞–π—Ç–∏ –Ω–∞—Å–µ–ª–µ–Ω—ñ –ø—É–Ω–∫—Ç–∏ –∑–∞ –ø–µ—Ä—à–∏–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏
    –ü–æ–≤–µ—Ä—Ç–∞—î —Å–ø–∏—Å–æ–∫ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ –ø–æ –æ–±–ª–∞—Å—Ç—è—Ö
    """
    prefix_lower = prefix.lower()
    results = []
    
    for settlement_name, settlements_list in UKRAINE_SETTLEMENTS.items():
        if settlement_name.lower().startswith(prefix_lower):
            for settlement in settlements_list:
                results.append({
                    'name': settlement_name,
                    'full_name': settlement.get('full_name', f"{settlement_name} ({settlement['region']})"),
                    'region': settlement['region'],
                    'lat': settlement['lat'],
                    'lon': settlement['lon'],
                    'type': settlement['type'],
                    'population': settlement.get('population', 0)
                })
    
    # –°–æ—Ä—Ç—É—î–º–æ –∑–∞ –Ω–∞—Å–µ–ª–µ–Ω–Ω—è–º (–±—ñ–ª—å—à—ñ –ø–µ—Ä—à–∏–º–∏), –ø–æ—Ç—ñ–º –∑–∞ –Ω–∞–∑–≤–æ—é
    results.sort(key=lambda x: (x['population'], x['name']), reverse=True)
    
    return results[:15]  # –û–±–º–µ–∂—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏

def get_settlement_coordinates(settlement_name: str, region: str = None) -> Tuple[Optional[float], Optional[float]]:
    """
    –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –Ω–∞—Å–µ–ª–µ–Ω–æ–≥–æ –ø—É–Ω–∫—Ç—É
    –Ø–∫—â–æ —î –∫—ñ–ª—å–∫–∞ –ø—É–Ω–∫—Ç—ñ–≤ –∑ –æ–¥–Ω–∞–∫–æ–≤–æ—é –Ω–∞–∑–≤–æ—é - –∑–∞–ø–∏—Ç—É—î–º–æ –æ–±–ª–∞—Å—Ç—å
    """
    if settlement_name not in UKRAINE_SETTLEMENTS:
        return None, None
    
    settlements = UKRAINE_SETTLEMENTS[settlement_name]
    
    # –Ø–∫—â–æ —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω –ø—É–Ω–∫—Ç –∑ —Ç–∞–∫–æ—é –Ω–∞–∑–≤–æ—é
    if len(settlements) == 1:
        return settlements[0]['lat'], settlements[0]['lon']
    
    # –Ø–∫—â–æ –∫—ñ–ª—å–∫–∞ –ø—É–Ω–∫—Ç—ñ–≤ - –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∫–∞–∑–∞—Ç–∏ –æ–±–ª–∞—Å—Ç—å
    if region:
        for settlement in settlements:
            if settlement['region'].lower() == region.lower():
                return settlement['lat'], settlement['lon']
    
    # –Ø–∫—â–æ –æ–±–ª–∞—Å—Ç—å –Ω–µ –≤–∫–∞–∑–∞–Ω–∞ - –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø–µ—Ä—à–∏–π (–Ω–∞–π–±—ñ–ª—å—à–∏–π)
    return settlements[0]['lat'], settlements[0]['lon']

def format_settlement_list(settlements: List[dict]) -> str:
    """–§–æ—Ä–º–∞—Ç—É–≤–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ –Ω–∞—Å–µ–ª–µ–Ω–∏—Ö –ø—É–Ω–∫—Ç—ñ–≤ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è"""
    if not settlements:
        return "–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –Ω–∞—Å–µ–ª–µ–Ω–∏—Ö –ø—É–Ω–∫—Ç—ñ–≤"
    
    result = []
    for i, settlement in enumerate(settlements, 1):
        pop_str = f" ({settlement['population']:,} —á–æ–ª.)" if settlement['population'] > 0 else ""
        result.append(f"{i}. {settlement['full_name']}{pop_str}")
    
    return "\n".join(result)

# ============================================================================
# OPEN-METEO API –§–£–ù–ö–¶–Ü–á
# ============================================================================

def get_openmeteo_weather(lat: float, lon: float) -> Optional[dict]:
    """–û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–≥–æ–¥—É –∑ Open-Meteo API"""
    try:
        url = "https://api.open-meteo.com/v1/forecast"
        
        params = {
            'latitude': lat,
            'longitude': lon,
            'current': [
                'temperature_2m', 'relative_humidity_2m', 'apparent_temperature',
                'precipitation', 'rain', 'snowfall', 'weather_code',
                'cloud_cover', 'pressure_msl', 'wind_speed_10m',
                'wind_direction_10m', 'wind_gusts_10m'
            ],
            'hourly': [
                'wind_speed_10m', 'wind_direction_10m',
                'wind_speed_80m', 'wind_direction_80m',
                'wind_speed_120m', 'wind_direction_120m',
                'wind_speed_180m', 'wind_direction_180m'
            ],
            'timezone': 'auto',
            'forecast_days': 1
        }
        
        response = requests.get(url, params=params, timeout=10)
        
        if response.status_code == 200:
            return response.json()
        else:
            logger.error(f"Open-Meteo API error: {response.status_code}")
            return None
            
    except Exception as e:
        logger.error(f"Open-Meteo error: {e}")
        return None

def get_wind_direction(degrees: float) -> str:
    """–ö–æ–Ω–≤–µ—Ä—Ç—É–≤–∞—Ç–∏ –≥—Ä–∞–¥—É—Å–∏ —É –Ω–∞–∑–≤—É –Ω–∞–ø—Ä—è–º–∫—É –≤—ñ—Ç—Ä—É"""
    if degrees is None:
        return "–ù–µ –≤–∏–∑–Ω–∞—á–µ–Ω–æ"
    
    directions = ["–ü—ñ–≤–Ω—ñ—á–Ω–∏–π", "–ü—ñ–≤–Ω—ñ—á–Ω–æ-—Å—Ö—ñ–¥–Ω–∏–π", "–°—Ö—ñ–¥–Ω–∏–π", "–ü—ñ–≤–¥–µ–Ω–Ω–æ-—Å—Ö—ñ–¥–Ω–∏–π",
                 "–ü—ñ–≤–¥–µ–Ω–Ω–∏–π", "–ü—ñ–≤–¥–µ–Ω–Ω–æ-–∑–∞—Ö—ñ–¥–Ω–∏–π", "–ó–∞—Ö—ñ–¥–Ω–∏–π", "–ü—ñ–≤–Ω—ñ—á–Ω–æ-–∑–∞—Ö—ñ–¥–Ω–∏–π"]
    index = round(degrees / 45) % 8
    return f"{directions[index]} ({int(degrees)}¬∞)"

def get_weather_description(weather_code: int) -> str:
    """–û—Ç—Ä–∏–º–∞—Ç–∏ –æ–ø–∏—Å –ø–æ–≥–æ–¥–∏ –∑–∞ –∫–æ–¥–æ–º Open-Meteo"""
    weather_codes = {
        0: "–Ø—Å–Ω–µ –Ω–µ–±–æ", 1: "–ü–µ—Ä–µ–≤–∞–∂–Ω–æ —è—Å–Ω–æ", 2: "–ú—ñ–Ω–ª–∏–≤–∞ —Ö–º–∞—Ä–Ω—ñ—Å—Ç—å", 3: "–•–º–∞—Ä–Ω–æ",
        45: "–¢—É–º–∞–Ω", 48: "–ü–æ–∫—Ä–∏—Ç–∏–π —ñ–Ω–µ—î–º —Ç—É–º–∞–Ω",
        51: "–õ–µ–≥–∫–∞ –º—Ä—è–∫–∞", 53: "–ü–æ–º—ñ—Ä–Ω–∞ –º—Ä—è–∫–∞", 55: "–ì—É—Å—Ç–∞ –º—Ä—è–∫–∞",
        61: "–ù–µ–≤–µ–ª–∏–∫–∏–π –¥–æ—â", 63: "–ü–æ–º—ñ—Ä–Ω–∏–π –¥–æ—â", 65: "–°–∏–ª—å–Ω–∏–π –¥–æ—â",
        71: "–ù–µ–≤–µ–ª–∏–∫–∏–π —Å–Ω—ñ–≥–æ–ø–∞–¥", 73: "–ü–æ–º—ñ—Ä–Ω–∏–π —Å–Ω—ñ–≥–æ–ø–∞–¥", 75: "–°–∏–ª—å–Ω–∏–π —Å–Ω—ñ–≥–æ–ø–∞–¥",
        80: "–ù–µ–≤–µ–ª–∏–∫—ñ –∑–ª–∏–≤–∏", 81: "–ü–æ–º—ñ—Ä–Ω—ñ –∑–ª–∏–≤–∏", 82: "–°–∏–ª—å–Ω—ñ –∑–ª–∏–≤–∏",
        95: "–ì—Ä–æ–∑–∞", 96: "–ì—Ä–æ–∑–∞ –∑ –≥—Ä–∞–¥–æ–º", 99: "–°–∏–ª—å–Ω–∞ –≥—Ä–æ–∑–∞ –∑ –≥—Ä–∞–¥–æ–º"
    }
    return weather_codes.get(weather_code, "–ù–µ–≤—ñ–¥–æ–º–æ")

def calculate_cloud_base(temperature: float, humidity: float) -> Optional[int]:
    """–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –Ω–∏–∂–Ω—é –∫—Ä–æ–º–∫—É —Ö–º–∞—Ä"""
    if temperature is None or humidity is None:
        return None
    
    t = temperature
    rh = humidity
    
    # –§–æ—Ä–º—É–ª–∞ –ú–∞–≥–Ω—É—Å–∞ –¥–ª—è —Ç–æ—á–∫–∏ —Ä–æ—Å–∏
    a = 17.27
    b = 237.7
    alpha = ((a * t) / (b + t)) + math.log(rh / 100.0)
    dew_point = (b * alpha) / (a - alpha)
    
    # –§–æ—Ä–º—É–ª–∞ –¥–ª—è –≤–∏—Å–æ—Ç–∏ —Ö–º–∞—Ä (–º–µ—Ç—Ä–∏)
    cloud_base = 125 * (t - dew_point)
    
    # –û–±–º–µ–∂–µ–Ω–Ω—è
    if cloud_base < 100:
        return 100
    elif cloud_base > 5000:
        return 5000
    return int(cloud_base)

def format_weather_message(settlement_name: str, region: str, weather_data: dict) -> str:
    """–§–æ—Ä–º–∞—Ç—É–≤–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –ø–æ–≥–æ–¥–æ—é"""
    try:
        current = weather_data['current']
        hourly = weather_data.get('hourly', {})
        
        # –û—Å–Ω–æ–≤–Ω—ñ –¥–∞–Ω—ñ
        temp = current.get('temperature_2m', 0)
        feels_like = current.get('apparent_temperature', temp)
        humidity = current.get('relative_humidity_2m', 0)
        pressure = current.get('pressure_msl', 0)
        cloud_cover = current.get('cloud_cover', 0)
        weather_code = current.get('weather_code', 0)
        
        # –û–ø–∞–¥–∏
        precipitation = current.get('precipitation', 0)
        rain = current.get('rain', 0)
        snowfall = current.get('snowfall', 0)
        
        # –í—ñ—Ç–µ—Ä
        wind_speed_10m = current.get('wind_speed_10m', 0)
        wind_dir_10m = current.get('wind_direction_10m')
        wind_gusts_10m = current.get('wind_gusts_10m', 0)
        
        # –û–ø–∏—Å –ø–æ–≥–æ–¥–∏
        weather_desc = get_weather_description(weather_code)
        
        # –ù–∏–∂–Ω—è –∫—Ä–æ–º–∫–∞ —Ö–º–∞—Ä
        cloud_base = calculate_cloud_base(temp, humidity)
        
        # –í—ñ—Ç–µ—Ä –Ω–∞ –≤–∏—Å–æ—Ç–∞—Ö
        current_hour = datetime.now().hour
        wind_at_heights = {}
        
        if 'time' in hourly and 'wind_speed_80m' in hourly:
            times = hourly['time']
            current_index = 0
            
            for i, time_str in enumerate(times):
                try:
                    hour = int(time_str.split('T')[1].split(':')[0])
                    if hour == current_hour:
                        current_index = i
                        break
                except:
                    continue
            
            # –í—ñ—Ç–µ—Ä –Ω–∞ —Ä—ñ–∑–Ω–∏—Ö –≤–∏—Å–æ—Ç–∞—Ö
            heights = [
                ('400m', 'wind_speed_80m', 'wind_direction_80m', 0.7),
                ('600m', 'wind_speed_80m', 'wind_direction_80m', 1.0),
                ('800m', 'wind_speed_120m', 'wind_direction_120m', 1.0),
                ('1000m', 'wind_speed_180m', 'wind_direction_180m', 1.0),
            ]
            
            for height_name, speed_key, dir_key, factor in heights:
                if speed_key in hourly and dir_key in hourly:
                    speeds = hourly[speed_key]
                    dirs = hourly[dir_key]
                    if len(speeds) > current_index and len(dirs) > current_index:
                        wind_at_heights[height_name] = {
                            'speed': speeds[current_index] * factor,
                            'direction': dirs[current_index],
                            'height': height_name
                        }
        
        # –§–æ—Ä–º—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        message = f"üå§ *–ü–æ–≥–æ–¥–∞ –≤ {settlement_name} ({region})*\n\n"
        
        message += f"üìä *–ó–∞–≥–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:*\n"
        message += f"‚Ä¢ –°—Ç–∞–Ω: *{weather_desc}*\n"
        message += f"‚Ä¢ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: *{temp:.1f}¬∞C*\n"
        message += f"‚Ä¢ –í—ñ–¥—á—É–≤–∞—î—Ç—å—Å—è —è–∫: *{feels_like:.1f}¬∞C*\n"
        message += f"‚Ä¢ –í–æ–ª–æ–≥—ñ—Å—Ç—å: *{humidity}%*\n"
        message += f"‚Ä¢ –¢–∏—Å–∫: *{pressure:.0f} hPa*\n\n"
        
        # –í—ñ—Ç–µ—Ä –Ω–∞ –∑–µ–º–ª—ñ
        wind_dir_text = get_wind_direction(wind_dir_10m)
        message += f"üí® *–í—ñ—Ç–µ—Ä –Ω–∞ –∑–µ–º–ª—ñ (10–º):*\n"
        message += f"‚Ä¢ –®–≤–∏–¥–∫—ñ—Å—Ç—å: *{wind_speed_10m:.1f} –º/—Å*\n"
        message += f"‚Ä¢ –ü–æ—Ä–∏–≤–∏: *{wind_gusts_10m:.1f} –º/—Å*\n"
        message += f"‚Ä¢ –ù–∞–ø—Ä—è–º–æ–∫: *{wind_dir_text}*\n\n"
        
        # –í—ñ—Ç–µ—Ä –Ω–∞ –≤–∏—Å–æ—Ç–∞—Ö
        if wind_at_heights:
            message += f"üåÄ *–í—ñ—Ç–µ—Ä –Ω–∞ –≤–∏—Å–æ—Ç–∞—Ö:*\n"
            for height in ['400m', '600m', '800m', '1000m']:
                if height in wind_at_heights:
                    data = wind_at_heights[height]
                    wind_dir = get_wind_direction(data['direction'])
                    message += f"‚Ä¢ {height}: *{data['speed']:.1f} –º/—Å*, {wind_dir}\n"
            message += f"\n"
        
        # –û–ø–∞–¥–∏
        message += f"üåß *–û–ø–∞–¥–∏ (–∑–∞ –≥–æ–¥–∏–Ω—É):*\n"
        message += f"‚Ä¢ –ó–∞–≥–∞–ª—å–Ω—ñ: *{precipitation:.1f} –º–º*\n"
        message += f"‚Ä¢ –î–æ—â: *{rain:.1f} –º–º*\n"
        message += f"‚Ä¢ –°–Ω—ñ–≥: *{snowfall:.1f} –º–º*\n\n"
        
        # –•–º–∞—Ä–Ω—ñ—Å—Ç—å
        message += f"‚òÅÔ∏è *–•–º–∞—Ä–Ω—ñ—Å—Ç—å:*\n"
        message += f"‚Ä¢ –†—ñ–≤–µ–Ω—å: *{cloud_cover}%*\n"
        if cloud_base:
            message += f"‚Ä¢ –ù–∏–∂–Ω—è –∫—Ä–æ–º–∫–∞ —Ö–º–∞—Ä: *{cloud_base} –º*\n"
        else:
            message += f"‚Ä¢ –ù–∏–∂–Ω—è –∫—Ä–æ–º–∫–∞ —Ö–º–∞—Ä: *–ù–µ –≤–∏–∑–Ω–∞—á–µ–Ω–æ*\n"
        
        message += f"\nüì° *–î–∂–µ—Ä–µ–ª–æ:* Open-Meteo API\n"
        message += f"üîÑ *–û–Ω–æ–≤–ª–µ–Ω–æ:* {datetime.now().strftime('%H:%M')}"
        
        return message
        
    except Exception as e:
        logger.error(f"Error formatting weather message: {e}")
        return None

# ============================================================================
# –û–ë–†–û–ë–ù–ò–ö–ò –ö–û–ú–ê–ù–î
# ============================================================================

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    user = update.effective_user
    
    keyboard = [
        [InlineKeyboardButton("üîç –ü–æ—à—É–∫ –Ω–∞—Å–µ–ª–µ–Ω–æ–≥–æ –ø—É–Ω–∫—Ç—É", callback_data="search_settlement")],
        [InlineKeyboardButton("üèô –û–±–ª–∞—Å–Ω—ñ —Ü–µ–Ω—Ç—Ä–∏", callback_data="regional_centers")],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑–∏", callback_data="database_stats")],
        [InlineKeyboardButton("‚ùì –î–æ–ø–æ–º–æ–≥–∞", callback_data="help")]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        f"üëã –í—ñ—Ç–∞—é, {user.first_name}!\n\n"
        f"üá∫üá¶ *–£–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –±–æ—Ç –ø–æ–≥–æ–¥–∏*\n\n"
        f"üìã *–û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ:*\n"
        f"‚Ä¢ –ë–∞–∑–∞ {len(ALL_SETTLEMENT_NAMES)} –Ω–∞—Å–µ–ª–µ–Ω–∏—Ö –ø—É–Ω–∫—Ç—ñ–≤\n"
        f"‚Ä¢ –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –º—ñ—Å—Ç –∑ –æ–¥–Ω–∞–∫–æ–≤–æ—é –Ω–∞–∑–≤–æ—é –≤ —Ä—ñ–∑–Ω–∏—Ö –æ–±–ª–∞—Å—Ç—è—Ö\n"
        f"‚Ä¢ –î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –≤—ñ—Ç–µ—Ä –Ω–∞ 5 –≤–∏—Å–æ—Ç–∞—Ö\n"
        f"‚Ä¢ –ê–≤—Ç–æ–¥–æ–ø–æ–≤–Ω–µ–Ω–Ω—è –Ω–∞–∑–≤\n\n"
        f"‚úçÔ∏è *–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É –Ω–∞—Å–µ–ª–µ–Ω–æ–≥–æ –ø—É–Ω–∫—Ç—É:*",
        parse_mode='Markdown',
        reply_markup=reply_markup
    )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /help"""
    help_text = (
        "‚ÑπÔ∏è *–î–æ–≤—ñ–¥–∫–∞ –ø–æ –±–æ—Ç—É*\n\n"
        "*–ü–æ—à—É–∫ –Ω–∞—Å–µ–ª–µ–Ω–∏—Ö –ø—É–Ω–∫—Ç—ñ–≤:*\n"
        "1. –ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É (–º—ñ–Ω—ñ–º—É–º 2 —Å–∏–º–≤–æ–ª–∏)\n"
        "2. –Ø–∫—â–æ —î –∫—ñ–ª—å–∫–∞ –ø—É–Ω–∫—Ç—ñ–≤ –∑ –æ–¥–Ω–∞–∫–æ–≤–æ—é –Ω–∞–∑–≤–æ—é - –æ–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å\n"
        "3. –û—Ç—Ä–∏–º–∞–π—Ç–µ –¥–µ—Ç–∞–ª—å–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥–∏\n\n"
        "*–ü—Ä–∏–∫–ª–∞–¥–∏ –∑–∞–ø–∏—Ç—ñ–≤:*\n"
        "‚Ä¢ '–∫–∏' ‚Üí –ö–∏—ó–≤\n"
        "‚Ä¢ '–Ω–æ–≤' ‚Üí –ø–æ–∫–∞–∂–µ –≤—Å—ñ –ø—É–Ω–∫—Ç–∏, —â–æ –ø–æ—á–∏–Ω–∞—é—Ç—å—Å—è –Ω–∞ '–Ω–æ–≤'\n"
        "‚Ä¢ '–ø–µ—Ä–≤–æ–º–∞–π—Å—å–∫' ‚Üí –ø–æ–∫–∞–∂–µ –æ–±–∏–¥–≤–∞ –ü–µ—Ä–≤–æ–º–∞–π—Å—å–∫–∏\n\n"
        "*–ö–æ–º–∞–Ω–¥–∏:*\n"
        "/start - –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é\n"
        "/help - —Ü—è –¥–æ–≤—ñ–¥–∫–∞\n"
        "/find [–Ω–∞–∑–≤–∞] - –ø–æ—à—É–∫ –Ω–∞—Å–µ–ª–µ–Ω–æ–≥–æ –ø—É–Ω–∫—Ç—É\n"
        "/regions - —Å–ø–∏—Å–æ–∫ –æ–±–ª–∞—Å—Ç–µ–π\n"
        "/stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö\n\n"
        "*–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø–æ–≥–æ–¥—É:*\n"
        "‚Ä¢ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–≤—ñ—Ç—Ä—è\n"
        "‚Ä¢ –í—ñ—Ç–µ—Ä –Ω–∞ –∑–µ–º–ª—ñ —Ç–∞ –≤–∏—Å–æ—Ç–∞—Ö 400, 600, 800, 1000 –º\n"
        "‚Ä¢ –ù–∞–ø—Ä—è–º –≤—ñ—Ç—Ä—É –≤ –≥—Ä–∞–¥—É—Å–∞—Ö\n"
        "‚Ä¢ –í–æ–ª–æ–≥—ñ—Å—Ç—å –ø–æ–≤—ñ—Ç—Ä—è\n"
        "‚Ä¢ –û–ø–∞–¥–∏ (–¥–æ—â, —Å–Ω—ñ–≥)\n"
        "‚Ä¢ –ù–∏–∂–Ω—è –∫—Ä–æ–º–∫–∞ —Ö–º–∞—Ä"
    )
    
    await update.message.reply_text(help_text, parse_mode='Markdown')

async def find_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /find - –ø–æ—à—É–∫ –Ω–∞—Å–µ–ª–µ–Ω–æ–≥–æ –ø—É–Ω–∫—Ç—É"""
    if not context.args:
        await update.message.reply_text(
            "üîç *–ü–æ—à—É–∫ –Ω–∞—Å–µ–ª–µ–Ω–æ–≥–æ –ø—É–Ω–∫—Ç—É*\n\n"
            "–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: /find [–Ω–∞–∑–≤–∞ –∞–±–æ —á–∞—Å—Ç–∏–Ω–∞ –Ω–∞–∑–≤–∏]\n\n"
            "*–ü—Ä–∏–∫–ª–∞–¥–∏:*\n"
            "/find –∫–∏\n"
            "/find –Ω–æ–≤\n"
            "/find –ø–µ—Ä–≤–æ–º–∞–π—Å—å–∫\n\n"
            "üìù *–ü–æ—Ä–∞–¥–∞:* –ú—ñ–Ω—ñ–º—É–º 2 —Å–∏–º–≤–æ–ª–∏",
            parse_mode='Markdown'
        )
        return
    
    search_query = ' '.join(context.args)
    await search_settlements(update, search_query, context)

async def regions_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /regions - —Å–ø–∏—Å–æ–∫ –æ–±–ª–∞—Å—Ç–µ–π –£–∫—Ä–∞—ó–Ω–∏"""
    regions = set()
    for settlements_list in UKRAINE_SETTLEMENTS.values():
        for settlement in settlements_list:
            regions.add(settlement['region'])
    
    regions_list = sorted(list(regions))
    regions_text = "\n".join([f"‚Ä¢ {region}" for region in regions_list])
    
    await update.message.reply_text(
        f"üìã *–û–±–ª–∞—Å—Ç—ñ –£–∫—Ä–∞—ó–Ω–∏:*\n\n{regions_text}\n\n"
        f"‚ÑπÔ∏è –í—Å—å–æ–≥–æ: {len(regions_list)} –æ–±–ª–∞—Å—Ç–µ–π",
        parse_mode='Markdown'
    )

async def stats_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö"""
    total_settlements = 0
    settlements_by_region = {}
    settlements_by_type = {}
    
    for settlements_list in UKRAINE_SETTLEMENTS.values():
        total_settlements += len(settlements_list)
        for settlement in settlements_list:
            # –ü–æ –æ–±–ª–∞—Å—Ç—è—Ö
            region = settlement['region']
            settlements_by_region[region] = settlements_by_region.get(region, 0) + 1
            
            # –ü–æ —Ç–∏–ø–∞—Ö
            settlement_type = settlement['type']
            settlements_by_type[settlement_type] = settlements_by_type.get(settlement_type, 0) + 1
    
    # –§–æ—Ä–º—É—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    stats_text = f"üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö:*\n\n"
    stats_text += f"‚Ä¢ –£–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –Ω–∞–∑–≤: *{len(ALL_SETTLEMENT_NAMES)}*\n"
    stats_text += f"‚Ä¢ –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Å—ñ–≤: *{total_settlements}*\n"
    stats_text += f"‚Ä¢ –û–±–ª–∞—Å—Ç–µ–π: *{len(settlements_by_region)}*\n\n"
    
    stats_text += "*–ù–∞–π–±—ñ–ª—å—à–µ –Ω–∞—Å–µ–ª–µ–Ω–Ω—è:*\n"
    # –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Ç–æ–ø-5 –Ω–∞–π–±—ñ–ª—å—à–∏—Ö –º—ñ—Å—Ç
    all_settlements = []
    for name, settlements_list in UKRAINE_SETTLEMENTS.items():
        for settlement in settlements_list:
            if settlement.get('population', 0) > 0:
                all_settlements.append((name, settlement))
    
    all_settlements.sort(key=lambda x: x[1].get('population', 0), reverse=True)
    
    for i, (name, settlement) in enumerate(all_settlements[:5], 1):
        stats_text += f"{i}. {name} ({settlement['region']}): {settlement['population']:,} —á–æ–ª.\n"
    
    stats_text += f"\n‚ÑπÔ∏è *–î—É–±–ª—ñ–∫–∞—Ç–∏ –Ω–∞–∑–≤:*\n"
    duplicates = [name for name, lst in UKRAINE_SETTLEMENTS.items() if len(lst) > 1]
    if duplicates:
        for dup in duplicates[:5]:  # –ü–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä—à—ñ 5
            regions = [s['region'] for s in UKRAINE_SETTLEMENTS[dup]]
            stats_text += f"‚Ä¢ {dup}: {', '.join(regions)}\n"
        if len(duplicates) > 5:
            stats_text += f"‚Ä¢ ... —Ç–∞ —â–µ {len(duplicates) - 5} —ñ–Ω—à–∏—Ö\n"
    else:
        stats_text += "–ù–µ–º–∞—î –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤\n"
    
    await update.message.reply_text(stats_text, parse_mode='Markdown')

async def search_settlements(update: Update, query: str, context: Optional[ContextTypes.DEFAULT_TYPE] = None):
    """–ü–æ—à—É–∫ –Ω–∞—Å–µ–ª–µ–Ω–∏—Ö –ø—É–Ω–∫—Ç—ñ–≤"""
    if len(query) < 2:
        await update.message.reply_text(
            "‚ùå *–ó–∞–Ω–∞–¥—Ç–æ –∫–æ—Ä–æ—Ç–∫–∏–π –∑–∞–ø–∏—Ç.*\n\n"
            "–í–≤–µ–¥—ñ—Ç—å –º—ñ–Ω—ñ–º—É–º 2 —Å–∏–º–≤–æ–ª–∏ –¥–ª—è –ø–æ—à—É–∫—É.",
            parse_mode='Markdown'
        )
        return
    
    settlements = find_settlements_by_prefix(query)
    
    if not settlements:
        await update.message.reply_text(
            f"‚ùå *–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –Ω–∞—Å–µ–ª–µ–Ω–∏—Ö –ø—É–Ω–∫—Ç—ñ–≤ –∑–∞ –∑–∞–ø–∏—Ç–æ–º '{query}'*\n\n"
            f"üìù *–ü–æ—Ä–∞–¥–∏:*\n"
            f"‚Ä¢ –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞–ø–∏—Å–∞–Ω–Ω—è\n"
            f"‚Ä¢ –°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à—É —á–∞—Å—Ç–∏–Ω—É –Ω–∞–∑–≤–∏\n" 
            f"‚Ä¢ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —É–∫—Ä–∞—ó–Ω—Å—å–∫—É –º–æ–≤—É",
            parse_mode='Markdown'
        )
        return
    
    # –Ø–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω–æ —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç - –æ–¥—Ä–∞–∑—É –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–≥–æ–¥—É
    if len(settlements) == 1:
        settlement = settlements[0]
        await process_weather_request(update, settlement['name'], settlement['region'])
        return
    
    # –Ø–∫—â–æ –∫—ñ–ª—å–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ - –ø–æ–∫–∞–∑—É—î–º–æ —Å–ø–∏—Å–æ–∫
    message = f"üîç *–ó–Ω–∞–π–¥–µ–Ω–æ {len(settlements)} –Ω–∞—Å–µ–ª–µ–Ω–∏—Ö –ø—É–Ω–∫—Ç—ñ–≤:*\n\n"
    
    # –ì—Ä—É–ø—É—î–º–æ –∑–∞ –Ω–∞–∑–≤–æ—é (—è–∫—â–æ —î –¥—É–±–ª—ñ–∫–∞—Ç–∏)
    grouped_results = {}
    for settlement in settlements:
        if settlement['name'] not in grouped_results:
            grouped_results[settlement['name']] = []
        grouped_results[settlement['name']].append(settlement)
    
    # –§–æ—Ä–º—É—î–º–æ —Å–ø–∏—Å–æ–∫
    for i, (name, items) in enumerate(grouped_results.items(), 1):
        if len(items) == 1:
            # –û–¥–∏–Ω –ø—É–Ω–∫—Ç –∑ —Ç–∞–∫–æ—é –Ω–∞–∑–≤–æ—é
            settlement = items[0]
            pop_str = f" ({settlement['population']:,} —á–æ–ª.)" if settlement['population'] > 0 else ""
            message += f"{i}. {name} ({settlement['region']}){pop_str}\n"
        else:
            # –ö—ñ–ª—å–∫–∞ –ø—É–Ω–∫—Ç—ñ–≤ –∑ –æ–¥–Ω–∞–∫–æ–≤–æ—é –Ω–∞–∑–≤–æ—é
            message += f"{i}. {name}:\n"
            for j, settlement in enumerate(items, 1):
                pop_str = f" ({settlement['population']:,} —á–æ–ª.)" if settlement['population'] > 0 else ""
                message += f"   {j}. {settlement['region']}{pop_str}\n"
    
    message += "\nüìù *–í–∏–±–µ—Ä—ñ—Ç—å –Ω–æ–º–µ—Ä –ø—É–Ω–∫—Ç—É –∞–±–æ –Ω–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤–Ω—É –Ω–∞–∑–≤—É –∑ –≤–∫–∞–∑–∞–Ω–Ω—è–º –æ–±–ª–∞—Å—Ç—ñ*"
    
    # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–æ—à—É–∫—É –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ
    if context and hasattr(update, 'message'):
        context.user_data['last_search_results'] = settlements
        context.user_data['last_search_query'] = query
    
    await update.message.reply_text(message, parse_mode='Markdown')

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–æ–±–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å"""
    text = update.message.text.strip()
    
    if text.startswith('/'):
        return
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Ü–µ –Ω–æ–º–µ—Ä –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø–æ—à—É–∫—É
    if 'last_search_results' in context.user_data and text.isdigit():
        index = int(text) - 1
        results = context.user_data['last_search_results']
        
        if 0 <= index < len(results):
            settlement = results[index]
            await process_weather_request(update, settlement['name'], settlement['region'])
            # –û—á–∏—â—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–æ—à—É–∫—É
            context.user_data.pop('last_search_results', None)
            return
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –º—ñ—Å—Ç–∏—Ç—å –Ω–∞–∑–≤—É –æ–±–ª–∞—Å—Ç—ñ –≤ –¥—É–∂–∫–∞—Ö
    import re
    pattern = r'(.+?)\s*\(([^)]+)\)'
    match = re.match(pattern, text)
    
    if match:
        settlement_name = match.group(1).strip()
        region = match.group(2).strip()
        
        # –®—É–∫–∞—î–º–æ —Ç–æ—á–Ω–µ —Å–ø—ñ–≤–ø–∞–¥—ñ–Ω–Ω—è
        if settlement_name in UKRAINE_SETTLEMENTS:
            settlements = UKRAINE_SETTLEMENTS[settlement_name]
            for settlement in settlements:
                if settlement['region'].lower() == region.lower():
                    await process_weather_request(update, settlement_name, region)
                    return
    
    # –ó–≤–∏—á–∞–π–Ω–∏–π –ø–æ—à—É–∫
    if len(text) >= 2:
        await search_settlements(update, text, context)
    else:
        await update.message.reply_text(
            "ü§î *–ù–µ —Ä–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ –∑–∞–ø–∏—Ç.*\n\n"
            "üìù *–§–æ—Ä–º–∞—Ç–∏ –∑–∞–ø–∏—Ç—ñ–≤:*\n"
            "‚Ä¢ –ù–∞–∑–≤–∞ –Ω–∞—Å–µ–ª–µ–Ω–æ–≥–æ –ø—É–Ω–∫—Ç—É (–Ω–∞–ø—Ä. '–ö–∏—ó–≤')\n"
            "‚Ä¢ –ß–∞—Å—Ç–∏–Ω–∞ –Ω–∞–∑–≤–∏ (–Ω–∞–ø—Ä. '–∫–∏')\n"
            "‚Ä¢ –ù–∞–∑–≤–∞ –∑ –æ–±–ª–∞—Å—Ç—é (–Ω–∞–ø—Ä. '–ù–æ–≤–æ–≥—Ä–∞–¥ (–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞)')\n"
            "‚Ä¢ –ù–æ–º–µ—Ä –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ —Å–ø–∏—Å–∫—É\n\n"
            "‚ÑπÔ∏è –ú—ñ–Ω—ñ–º—É–º 2 —Å–∏–º–≤–æ–ª–∏ –¥–ª—è –ø–æ—à—É–∫—É",
            parse_mode='Markdown'
        )


# ============================================================================
# –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–ò–ô –ü–†–û–°–¢–Ü–®–ò–ô –í–ê–†–Ü–ê–ù–¢ button_handler
# ============================================================================

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–æ–±–∫–∞ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–æ–∫"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    
    if data == "search_settlement":
        await query.edit_message_text(
            "üîç *–ü–æ—à—É–∫ –Ω–∞—Å–µ–ª–µ–Ω–æ–≥–æ –ø—É–Ω–∫—Ç—É*\n\n"
            "–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –∞–±–æ —á–∞—Å—Ç–∏–Ω—É –Ω–∞–∑–≤–∏:\n\n"
            "*–ü—Ä–∏–∫–ª–∞–¥–∏:*\n"
            "‚Ä¢ –ö–∏—ó–≤\n"
            "‚Ä¢ –∫–∏\n"
            "‚Ä¢ –Ω–æ–≤\n"
            "‚Ä¢ –ü–µ—Ä–≤–æ–º–∞–π—Å—å–∫ (–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞)\n\n"
            "üìù –ú—ñ–Ω—ñ–º—É–º 2 —Å–∏–º–≤–æ–ª–∏",
            parse_mode='Markdown'
        )
    
    elif data == "regional_centers":
        await show_regional_centers(query)
    
    elif data == "database_stats":
        await show_database_stats(query)
    
    elif data == "help":
        await show_help(query)
    
    elif data.startswith("weather_"):
        parts = data.split('_')
        if len(parts) >= 3:
            settlement_name = parts[1]
            region = '_'.join(parts[2:])
            await query.edit_message_text(
                f"üîç –ó–∞–≤–∞–Ω—Ç–∞–∂—É—é –ø–æ–≥–æ–¥—É –¥–ª—è {settlement_name} ({region})...",
                parse_mode='Markdown'
            )
            await process_weather_request(query, settlement_name, region)

async def show_regional_centers(query):
    """–ü–æ–∫–∞–∑–∞—Ç–∏ –æ–±–ª–∞—Å–Ω—ñ —Ü–µ–Ω—Ç—Ä–∏"""
    # –ó–Ω–∞—Ö–æ–¥–∏–º–æ –æ–±–ª–∞—Å–Ω—ñ —Ü–µ–Ω—Ç—Ä–∏
    regional_centers = []
    for name, settlements_list in UKRAINE_SETTLEMENTS.items():
        for settlement in settlements_list:
            if settlement['type'] in ['–æ–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä', '—Å—Ç–æ–ª–∏—Ü—è']:
                regional_centers.append({
                    'name': name,
                    'region': settlement['region'],
                    'population': settlement.get('population', 0)
                })
                break
    
    # –°–æ—Ä—Ç—É—î–º–æ –∑–∞ –Ω–∞—Å–µ–ª–µ–Ω–Ω—è–º
    regional_centers.sort(key=lambda x: x['population'], reverse=True)
    
    # –§–æ—Ä–º—É—î–º–æ —Å–ø–∏—Å–æ–∫
    centers_list = ""
    for i, center in enumerate(regional_centers, 1):
        centers_list += f"{i}. {center['name']} ({center['region']}): {center['population']:,} —á–æ–ª.\n"
    
    keyboard = []
    for center in regional_centers[:8]:
        keyboard.append([InlineKeyboardButton(
            f"üå§ {center['name']}", 
            callback_data=f"weather_{center['name']}_{center['region']}"
        )])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        f"üèô *–û–±–ª–∞—Å–Ω—ñ —Ü–µ–Ω—Ç—Ä–∏ –£–∫—Ä–∞—ó–Ω–∏:*\n\n{centers_list}\n"
        f"–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ–≥–æ–¥–∏:",
        parse_mode='Markdown',
        reply_markup=reply_markup
    )

async def show_database_stats(query):
    """–ü–æ–∫–∞–∑–∞—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–∞–∑–∏ –¥–∞–Ω–∏—Ö"""
    total_settlements = sum(len(v) for v in UKRAINE_SETTLEMENTS.values())
    regions = set()
    for settlements_list in UKRAINE_SETTLEMENTS.values():
        for settlement in settlements_list:
            regions.add(settlement['region'])
    
    # –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Ç–æ–ø-5 –Ω–∞–π–±—ñ–ª—å—à–∏—Ö –º—ñ—Å—Ç
    all_settlements = []
    for name, settlements_list in UKRAINE_SETTLEMENTS.items():
        for settlement in settlements_list:
            if settlement.get('population', 0) > 0:
                all_settlements.append((name, settlement))
    
    all_settlements.sort(key=lambda x: x[1].get('population', 0), reverse=True)
    
    stats_text = f"üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö:*\n\n"
    stats_text += f"‚Ä¢ –£–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –Ω–∞–∑–≤: *{len(UKRAINE_SETTLEMENTS)}*\n"
    stats_text += f"‚Ä¢ –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Å—ñ–≤: *{total_settlements}*\n"
    stats_text += f"‚Ä¢ –û–±–ª–∞—Å—Ç–µ–π: *{len(regions)}*\n\n"
    
    stats_text += "*–¢–æ–ø-5 –Ω–∞–π–±—ñ–ª—å—à–∏—Ö –º—ñ—Å—Ç:*\n"
    for i, (name, settlement) in enumerate(all_settlements[:5], 1):
        stats_text += f"{i}. {name} ({settlement['region']}): {settlement['population']:,} —á–æ–ª.\n"
    
    await query.edit_message_text(stats_text, parse_mode='Markdown')

async def show_help(query):
    """–ü–æ–∫–∞–∑–∞—Ç–∏ –¥–æ–≤—ñ–¥–∫—É"""
    help_text = (
        "‚ÑπÔ∏è *–î–æ–≤—ñ–¥–∫–∞ –ø–æ –±–æ—Ç—É*\n\n"
        "*–ü–æ—à—É–∫ –Ω–∞—Å–µ–ª–µ–Ω–∏—Ö –ø—É–Ω–∫—Ç—ñ–≤:*\n"
        "1. –ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É (–º—ñ–Ω—ñ–º—É–º 2 —Å–∏–º–≤–æ–ª–∏)\n"
        "2. –Ø–∫—â–æ —î –∫—ñ–ª—å–∫–∞ –ø—É–Ω–∫—Ç—ñ–≤ –∑ –æ–¥–Ω–∞–∫–æ–≤–æ—é –Ω–∞–∑–≤–æ—é - –æ–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å\n"
        "3. –û—Ç—Ä–∏–º–∞–π—Ç–µ –¥–µ—Ç–∞–ª—å–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥–∏\n\n"
        "*–ü—Ä–∏–∫–ª–∞–¥–∏ –∑–∞–ø–∏—Ç—ñ–≤:*\n"
        "‚Ä¢ '–∫–∏' ‚Üí –ö–∏—ó–≤\n"
        "‚Ä¢ '–Ω–æ–≤' ‚Üí –ø–æ–∫–∞–∂–µ –≤—Å—ñ –ø—É–Ω–∫—Ç–∏, —â–æ –ø–æ—á–∏–Ω–∞—é—Ç—å—Å—è –Ω–∞ '–Ω–æ–≤'\n"
        "‚Ä¢ '–ø–µ—Ä–≤–æ–º–∞–π—Å—å–∫' ‚Üí –ø–æ–∫–∞–∂–µ –æ–±–∏–¥–≤–∞ –ü–µ—Ä–≤–æ–º–∞–π—Å—å–∫–∏\n\n"
        "*–ö–æ–º–∞–Ω–¥–∏:*\n"
        "/start - –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é\n"
        "/help - —Ü—è –¥–æ–≤—ñ–¥–∫–∞\n"
        "/find [–Ω–∞–∑–≤–∞] - –ø–æ—à—É–∫ –Ω–∞—Å–µ–ª–µ–Ω–æ–≥–æ –ø—É–Ω–∫—Ç—É\n"
        "/regions - —Å–ø–∏—Å–æ–∫ –æ–±–ª–∞—Å—Ç–µ–π\n"
        "/stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö\n\n"
        "*–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø–æ–≥–æ–¥—É:*\n"
        "‚Ä¢ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–≤—ñ—Ç—Ä—è\n"
        "‚Ä¢ –í—ñ—Ç–µ—Ä –Ω–∞ –∑–µ–º–ª—ñ —Ç–∞ –≤–∏—Å–æ—Ç–∞—Ö 400, 600, 800, 1000 –º\n"
        "‚Ä¢ –ù–∞–ø—Ä—è–º –≤—ñ—Ç—Ä—É –≤ –≥—Ä–∞–¥—É—Å–∞—Ö\n"
        "‚Ä¢ –í–æ–ª–æ–≥—ñ—Å—Ç—å –ø–æ–≤—ñ—Ç—Ä—è\n"
        "‚Ä¢ –û–ø–∞–¥–∏ (–¥–æ—â, —Å–Ω—ñ–≥)\n"
        "‚Ä¢ –ù–∏–∂–Ω—è –∫—Ä–æ–º–∫–∞ —Ö–º–∞—Ä"
    )
    
    await query.edit_message_text(help_text, parse_mode='Markdown')



async def process_weather_request(update: Update, settlement_name: str, region: str):
    """–û–±—Ä–æ–±–∫–∞ –∑–∞–ø–∏—Ç—É –ø—Ä–æ –ø–æ–≥–æ–¥—É"""
    try:
        # –û—Ç—Ä–∏–º—É—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
        lat, lon = get_settlement_coordinates(settlement_name, region)
        
        if not lat or not lon:
            error_msg = f"‚ùå –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è '{settlement_name}' ({region})"
            if hasattr(update, 'message'):
                await update.message.reply_text(error_msg, parse_mode='Markdown')
            else:
                await update.edit_message_text(error_msg, parse_mode='Markdown')
            return
        
        # –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        if hasattr(update, 'message'):
            message = await update.message.reply_text(
                f"üîç –û—Ç—Ä–∏–º—É—é –ø–æ–≥–æ–¥—É –¥–ª—è {settlement_name} ({region})...", 
                parse_mode='Markdown'
            )
        else:
            message = await update.edit_message_text(
                f"üîç –û—Ç—Ä–∏–º—É—é –ø–æ–≥–æ–¥—É –¥–ª—è {settlement_name} ({region})...", 
                parse_mode='Markdown'
            )
        
        # –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ–≥–æ–¥—É
        weather_data = get_openmeteo_weather(lat, lon)
        
        if not weather_data:
            error_text = (
                f"‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–≥–æ–¥—É –¥–ª—è {settlement_name} ({region})\n\n"
                f"–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:\n"
                f"‚Ä¢ –ü—Ä–æ–±–ª–µ–º–∏ –∑ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º\n"
                f"‚Ä¢ –¢–∏–º—á–∞—Å–æ–≤–∏–π –∑–±—ñ–π —Å–µ—Ä–≤—ñ—Å—É\n"
                f"‚Ä¢ –°–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ —Ö–≤–∏–ª–∏–Ω—É"
            )
            await message.edit_text(error_text, parse_mode='Markdown')
            return
        
        # –§–æ—Ä–º–∞—Ç—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        weather_text = format_weather_message(settlement_name, region, weather_data)
        
        if not weather_text:
            error_text = f"‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –¥–∞–Ω–∏—Ö –¥–ª—è {settlement_name}"
            await message.edit_text(error_text, parse_mode='Markdown')
            return
        
        await message.edit_text(weather_text, parse_mode='Markdown')
        logger.info(f"Weather sent for {settlement_name} ({region})")
            
    except Exception as e:
        logger.error(f"Error processing weather request: {e}")
        error_msg = "‚ùå –í–∏–Ω–∏–∫–ª–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ."
        
        if hasattr(update, 'message'):
            await update.message.reply_text(error_msg, parse_mode='Markdown')
        else:
            await update.edit_message_text(error_msg, parse_mode='Markdown')

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–æ–±–Ω–∏–∫ –ø–æ–º–∏–ª–æ–∫"""
    logger.error(f"Bot error: {context.error}", exc_info=True)

# ============================================================================
# –ì–û–õ–û–í–ù–ê –§–£–ù–ö–¶–Ü–Ø
# ============================================================================

def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    try:
        print("üöÄ Creating Telegram application...")
        
        application = Application.builder().token(TELEGRAM_TOKEN).build()
        
        # –î–æ–¥–∞–≤–∞–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –∫–æ–º–∞–Ω–¥
        application.add_handler(CommandHandler("start", start_command))
        application.add_handler(CommandHandler("help", help_command))
        application.add_handler(CommandHandler("find", find_command))
        application.add_handler(CommandHandler("regions", regions_command))
        application.add_handler(CommandHandler("stats", stats_command))
        
        # –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–æ–∫ (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–µ—Ä—à–∏–π –ø—Ä–æ—Å—Ç–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç)
        application.add_handler(CallbackQueryHandler(button_handler))
        
        # –û–±—Ä–æ–±–Ω–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
        application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
        
        # –û–±—Ä–æ–±–Ω–∏–∫ –ø–æ–º–∏–ª–æ–∫
        application.add_error_handler(error_handler)
        
        print("‚úÖ Application created")
        print(f"‚úÖ Database loaded: {len(ALL_SETTLEMENT_NAMES)} unique settlement names")
        print(f"‚úÖ Total records: {sum(len(v) for v in UKRAINE_SETTLEMENTS.values())}")
        print("‚úÖ Open-Meteo API: Ready")
        print("üöÄ Starting bot polling...")
        
        application.run_polling(
            drop_pending_updates=True,
            timeout=30,
            pool_timeout=30,
            allowed_updates=Update.ALL_TYPES
        )
        
    except Exception as e:
        print(f"‚ùå Error: {e}")
        logger.error(f"Application error: {e}")
        raise

if __name__ == '__main__':
    main()